name: Snyk Code Scan for OWASP Juice Shop PR Changes

on:
  pull_request:
    branches:
      - master
    types:
      - opened      # Trigger on PR creation
      - synchronize # Trigger on PR updates
      - reopened    # Trigger if PR is reopened

jobs:
  snyk_code_scan:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout the repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to compare changes

      # Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Install Snyk CLI
      - name: Install Snyk
        run: npm install -g snyk@latest

      # Get changed files in the PR
      - name: Get Changed Files
        id: changed_files
        run: |
          git fetch origin master
          CHANGED_FILES=$(git diff --name-only origin/master...HEAD | tr '\n' ' ' || true)
          echo "Changed files: $CHANGED_FILES"  # Debug output
          echo "files=$CHANGED_FILES" >> "$GITHUB_OUTPUT"

      # Run Snyk code scan on changed JavaScript files only
      - name: Snyk Code Scan
        id: snyk_code_scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          CHANGED_FILES="${{ steps.changed_files.outputs.files }}"
          echo "Scanning changed files: $CHANGED_FILES"
          if [ -n "$CHANGED_FILES" ]; then
            TOTAL_VULN=0
            for FILE in $CHANGED_FILES; do
              if [[ "$FILE" == *.js ]]; then  # Only scan JavaScript files for code vulnerabilities
                echo "Scanning file: $FILE"
                # Scan without severity threshold to report all vulnerabilities
                snyk code test --file="$FILE" --json > "snyk-code-report-${FILE//\//_}.json" 2> "snyk-code-log-${FILE//\//_}.txt" || true
                # Debug: Show Snyk command output and log file
                echo "Snyk command output for $FILE: $(cat snyk-code-log-${FILE//\//_}.txt || echo 'No output')"
                # Check if Snyk scanned only the specified file by inspecting the report
                if [ -s "snyk-code-report-${FILE//\//_}.json" ]; then
                  # Parse the report to ensure only the specified file has vulnerabilities
                  if jq -e '.runs[0].results | map(.locations[].physicalLocation.artifactLocation.uri) | unique | . == ["'"$FILE"'"]' > /dev/null 2>&1 < "snyk-code-report-${FILE//\//_}.json"; then
                    echo "Confirmed scan limited to $FILE"
                    if jq -e . > /dev/null 2>&1 < "snyk-code-report-${FILE//\//_}.json"; then
                      VULN_COUNT=$(jq '.runs[0].results | length' "snyk-code-report-${FILE//\//_}.json")
                      echo "Vulnerabilities in $FILE: $VULN_COUNT"
                      echo "Snyk Code Report Content: $(cat snyk-code-report-${FILE//\//_}.json || echo 'Empty or invalid')"
                      TOTAL_VULN=$((TOTAL_VULN + VULN_COUNT))
                    else
                      echo "Invalid JSON in snyk-code-report-${FILE//\//_}.json, skipping"
                    fi
                  else
                    echo "Warning: Snyk scanned files beyond $FILE. Limiting report to $FILE only."
                    # Filter results to only include vulnerabilities in $FILE
                    jq 'del(.runs[].results[] | select(.locations[].physicalLocation.artifactLocation.uri != "'"$FILE"'"))' "snyk-code-report-${FILE//\//_}.json" > "filtered-snyk-code-report-${FILE//\//_}.json"
                    if [ -s "filtered-snyk-code-report-${FILE//\//_}.json" ] && jq -e . > /dev/null 2>&1 < "filtered-snyk-code-report-${FILE//\//_}.json"; then
                      VULN_COUNT=$(jq '.runs[0].results | length' "filtered-snyk-code-report-${FILE//\//_}.json")
                      echo "Vulnerabilities in $FILE after filtering: $VULN_COUNT"
                      echo "Filtered Snyk Code Report Content: $(cat filtered-snyk-code-report-${FILE//\//_}.json || echo 'Empty or invalid')"
                      TOTAL_VULN=$((TOTAL_VULN + VULN_COUNT))
                      mv "filtered-snyk-code-report-${FILE//\//_}.json" "snyk-code-report-${FILE//\//_}.json"
                    else
                      echo "No vulnerabilities found in $FILE after filtering"
                    fi
                  fi
                else
                  echo "No vulnerabilities found or scan failed for $FILE"
                fi
              fi
            done
            echo "code_vuln_count=$TOTAL_VULN" >> $GITHUB_OUTPUT
          else
            echo "code_vuln_count=0" >> $GITHUB_OUTPUT
          fi

      # Generate comment based on scan results for changed JavaScript files only, with simplified, focused output
      - name: Generate Scan Comment
        id: comment
        run: |
          COMMENT="## Snyk Code Scan Results for OWASP Juice Shop PR Changes\n\n"
          
          CHANGED_FILES="${{ steps.changed_files.outputs.files }}"
          if [ -n "$CHANGED_FILES" ]; then
            VULN_FOUND=false
            for FILE in $CHANGED_FILES; do
              if [[ "$FILE" == *.js ]]; then  # Only consider JavaScript files
                REPORT_FILE="snyk-code-report-${FILE//\//_}.json"
                if [ -s "$REPORT_FILE" ] && jq -e . > /dev/null 2>&1 < "$REPORT_FILE"; then
                  VULN_COUNT=$(jq '.runs[0].results | length' "$REPORT_FILE")
                  if [ "$VULN_COUNT" -gt 0 ]; then
                    VULN_FOUND=true
                    # Keep header and summary, then list vulnerabilities with text and line range
                    COMMENT="$COMMENT### Vulnerabilities in $FILE\nFound $VULN_COUNT potential vulnerabilities in this file:\n"
                    for ((i=0; i<$VULN_COUNT; i++)); do
                      VULN_TEXT=$(jq -r '.runs[0].results['"$i"'].message.text' "$REPORT_FILE")
                      START_LINE=$(jq -r '.runs[0].results['"$i"'].locations[0].physicalLocation.region.startLine' "$REPORT_FILE")
                      END_LINE=$(jq -r '.runs[0].results['"$i"'].locations[0].physicalLocation.region.endLine' "$REPORT_FILE")
                      COMMENT="$COMMENT- $VULN_TEXT (Lines $START_LINEâ€“$END_LINE)\n"
                    done
                    COMMENT="$COMMENTTo view details, download the snyk-code-report-${FILE//\//_}.json artifact from GitHub Actions.\n\n"
                  fi
                fi
              fi
            done
            if [ "$VULN_FOUND" = false ]; then
              COMMENT="$COMMENT### Code Vulnerabilities\nNo vulnerabilities found in changed JavaScript code.\n"
            fi
          else
            COMMENT="$COMMENT### Code Vulnerabilities\nNo changed files detected in this PR.\n"
          fi
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Post comment to PR
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `${{ steps.comment.outputs.body }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      # Upload scan reports and logs as artifacts
      - name: Upload Snyk Code Report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-code-report
          path: snyk-code-report-*.json

      - name: Upload Snyk Code Logs
        uses: actions/upload-artifact@v4
        with:
          name: snyk-code-logs
          path: snyk-code-log-*.txt

      # Upload filtered reports for debugging (optional)
      - name: Upload Filtered Snyk Code Reports (Debug)
        uses: actions/upload-artifact@v4
        with:
          name: filtered-snyk-code-report
          path: filtered-snyk-code-report-*.json
